import{o as _,u as G,d as X,r as m,w as H,j as e,B as v,X as K,M as Q,A as Y,g as U,l as Z,m as ee,bb as se,s as I,y as te,k as ae,O as re}from"./index-CNxWMcuV.js";import{C as ne}from"./checkbox-CtHhNy01.js";import{L as ie}from"./license-plate-BoT_Ewxe.js";import{C as L}from"./car-brand-logo-BjPA7wLP.js";import{S as le}from"./square-check-big-B3VzhogF.js";import{M as ce}from"./message-square-BrEHgpxS.js";import"./car-DWakAuoX.js";function he(){const{user:s}=_(),{t:b,language:k}=G(),$=X(),[p,E]=m.useState([]),[P,S]=m.useState(!0),[x,D]=m.useState(!1),[u,N]=m.useState(new Set),[M,z]=m.useState(!1),j=m.useRef(new Map),C=m.useRef(new Map),A=m.useRef(new Map),R=async t=>{if(s)try{const r=new Map;t.forEach(i=>{const a=r.get(i.jobId)||[];a.push(i),r.set(i.jobId,a)}),j.current.size===0&&(await te()).forEach(a=>j.current.set(a.id,a));const n=Array.from(r.keys()).filter(i=>{const a=j.current.get(i);return a?s.role==="manager"||s.role==="office_staff"||s.role==="admin"?!0:s.role==="mechanic"?a.assignedMechanicId===s.id:!1:!1}),o=(await Promise.all(n.map(async i=>{const a=j.current.get(i),f=r.get(i)||[];f.sort((y,w)=>new Date(y.createdAt).getTime()-new Date(w.createdAt).getTime());const c=f[f.length-1];let h=C.current.get(a.vehicleId);h||(h=await ae(a.vehicleId),h&&C.current.set(a.vehicleId,h));let g=null;return c&&(g=A.current.get(c.senderId),g||(g=await re(c.senderId),g&&A.current.set(c.senderId,g))),{job:a,messages:f,lastMessage:c,vehicle:h,sender:g}}))).sort((i,a)=>{const f=i.lastMessage?new Date(i.lastMessage.createdAt).getTime():0;return(a.lastMessage?new Date(a.lastMessage.createdAt).getTime():0)-f});E(o),S(!1)}catch(r){console.error("Error processing messages:",r),S(!1)}};m.useEffect(()=>{if(!s)return;S(!0),j.current.clear(),C.current.clear(),A.current.clear();const t=H(r=>{R(r)});return()=>t()},[s]);const J=t=>{const r=new Set(u);r.has(t)?r.delete(t):r.add(t),N(r)},T=(s==null?void 0:s.role)==="mechanic",F=()=>{const t=p.filter(r=>T?r.job.status!=="completed":!0).map(r=>r.job.id);N(new Set(t))},O=()=>{N(new Set)},B=()=>{D(!1),N(new Set)},V=async()=>{if(!(!s||u.size===0)){z(!0);try{let t=0;const r=Array.from(u);for(const n of r){const l=await se(n,s.id);t+=l}B(),t>0?I.success(`Deleted ${t} message${t!==1?"s":""}`):I.info("No read messages to delete in selected conversations")}catch(t){console.error("Error deleting messages:",t),I.error("Failed to delete messages")}finally{z(!1)}}},q=(s==null?void 0:s.role)==="mechanic"||(s==null?void 0:s.role)==="manager"||(s==null?void 0:s.role)==="office_staff"||(s==null?void 0:s.role)==="admin",W=(s==null?void 0:s.role)==="mechanic";return P?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("p",{className:"text-muted-foreground",children:"Loading messages..."})}):e.jsxs("div",{className:"safe-top",children:[e.jsxs("div",{className:"px-4 pt-4 pb-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:b("nav.chats")}),e.jsx("p",{className:"text-muted-foreground",children:b("chats.title")})]}),q&&p.length>0&&!x&&e.jsxs(v,{variant:"outline",size:"sm",onClick:()=>D(!0),className:"gap-2",children:[e.jsx(le,{className:"h-4 w-4"}),b("chats.select")]})]}),x&&e.jsxs("div",{className:"mt-4 flex items-center justify-between bg-muted/50 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(v,{variant:"ghost",size:"sm",onClick:B,className:"h-8 w-8 p-0",children:e.jsx(K,{className:"h-4 w-4"})}),e.jsxs("span",{className:"text-sm font-medium",children:[u.size," selected"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{variant:"ghost",size:"sm",onClick:u.size===p.length?O:F,className:"text-xs",children:u.size===p.length?"Deselect all":"Select all"}),e.jsxs(v,{variant:"destructive",size:"sm",onClick:V,disabled:u.size===0||M,className:"gap-2",children:[e.jsx(Q,{className:"h-4 w-4"}),M?"Deleting...":"Delete"]})]})]})]}),e.jsx("div",{className:"px-4 space-y-3",children:p.length>0?p.map(({job:t,messages:r,lastMessage:n,vehicle:l,sender:o})=>{var y,w;const i=u.has(t.id),a=r.filter(d=>d.senderId!==(s==null?void 0:s.id)&&(!d.readBy||!d.readBy.includes((s==null?void 0:s.id)||""))).length,f=t.status!=="completed",c=T?f:!0,h=x&&c,g=t.customerName.split(" ").map(d=>d[0]).join("").toUpperCase().slice(0,2);return e.jsxs("div",{className:`relative flex gap-3 p-4 rounded-xl cursor-pointer transition-all duration-200 hover:bg-accent/50 ${i?"ring-2 ring-primary bg-primary/5":"bg-card border border-border"} ${x&&!c?"opacity-50":""}`,onClick:()=>{x?c&&J(t.id):$(`/jobs/${t.id}/messages`)},children:[h?e.jsx("div",{className:"flex-shrink-0 h-12 w-12 flex items-center justify-center",children:e.jsx(ne,{checked:i,onCheckedChange:()=>J(t.id),onClick:d=>d.stopPropagation(),className:"h-5 w-5"})}):l?e.jsx("div",{className:"flex-shrink-0 h-12 w-12 flex items-center justify-center",children:e.jsx(L,{brand:l.brand,size:"lg",className:"text-primary"})}):e.jsx("div",{className:`flex-shrink-0 h-12 w-12 rounded-full flex items-center justify-center text-sm font-semibold ${x&&!c?"bg-muted text-muted-foreground":"bg-primary/10 text-primary"}`,children:g}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[!W&&e.jsx("h4",{className:"font-semibold text-foreground truncate",children:t.customerName}),l&&e.jsx(ie,{plateNumber:l.licensePlate,size:"sm"})]}),e.jsx("span",{className:"text-xs text-muted-foreground flex-shrink-0 ml-2",children:n&&new Date(n.createdAt).toLocaleDateString("en-GB")})]}),l?e.jsxs("div",{className:"flex items-center gap-1.5 mb-1",children:[e.jsx(L,{brand:l.brand,size:"sm",className:"text-primary/70"}),e.jsxs("p",{className:"text-xs text-primary/80 font-medium truncate",children:[l.brand," ",l.model," (",l.year,")"]})]}):e.jsx("p",{className:"text-xs text-muted-foreground/60 mb-1",children:"No vehicle assigned"}),n&&o&&o.fullName?e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsxs(Y,{className:"h-5 w-5 flex-shrink-0",children:[o.email&&U(o.email)&&e.jsx(Z,{src:U(o.email),alt:o.fullName}),e.jsx(ee,{className:"text-[8px] bg-primary/10 text-primary",children:o.fullName.split(" ").map(d=>d[0]).join("").slice(0,2)})]}),e.jsxs("p",{className:`text-sm truncate flex-1 ${a>0?"text-foreground font-medium":"text-muted-foreground"}`,children:[e.jsxs("span",{className:a>0?"text-muted-foreground":"",children:[o.fullName,":"]})," ",((y=n.translations)==null?void 0:y[k])||n.originalText||(n.videoUrl?"ðŸŽ¥ Video":n.audioUrl?"ðŸŽ¤ Audio":n.imageUrl?"ðŸ“· Image":"")]})]}):n?e.jsx("p",{className:`text-sm truncate ${a>0?"text-foreground font-medium":"text-muted-foreground"}`,children:((w=n.translations)==null?void 0:w[k])||n.originalText||(n.videoUrl?"ðŸŽ¥ Video":n.audioUrl?"ðŸŽ¤ Audio":n.imageUrl?"ðŸ“· Image":"")}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"No messages yet"})]}),x&&!c&&e.jsx("span",{className:"absolute top-2 right-2 text-xs text-muted-foreground bg-muted px-2 py-0.5 rounded-full",children:"Completed"}),!x&&a>0&&e.jsx("div",{className:"absolute bottom-4 right-4 h-5 w-5 rounded-full bg-primary flex items-center justify-center",children:e.jsx("span",{className:"text-[10px] font-bold text-primary-foreground",children:a>9?"9+":a})})]},t.id)}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ce,{className:"h-16 w-16 mx-auto text-muted-foreground/30 mb-4"}),e.jsx("h3",{className:"font-medium text-lg mb-2",children:b("messages.noMessages")}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Messages will appear here when you start a conversation on a job"})]})})]})}export{he as default};
