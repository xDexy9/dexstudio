import{c as ce,o as de,r as o,j as e,_ as T,B as b,E as me,bq as xe,u as he,d as ue,e as A,i as M,n as pe,N as J,K as Q,M as je,Z as ge,x as fe,y as Ne,a1 as be,af as ve,aS as Ce,br as we}from"./index-CNxWMcuV.js";import{D as F,b as O,c as B,d as R,e as U,f as V}from"./dialog-CIS6byhQ.js";import{T as _}from"./textarea-D6buyuls.js";import{u as G}from"./use-toast-C9pXjDz0.js";import{M as $,U as ye}from"./user-check-YyTDvrUu.js";import{D as De,a as Se,E as Te,b as Ae,c as I,d as Me}from"./dropdown-menu-B4ssD23R.js";import{S as ke,a as Pe,b as Je,c as Ie,d as E}from"./select-CbHlLrev.js";import{U as W}from"./user-plus-CavHknNn.js";import{U as Z}from"./users-iVsLoBHZ.js";import{S as Le}from"./search-vDLcJ1l5.js";import{F as Ee}from"./filter-BR7a_zVs.js";import{T as Fe}from"./triangle-alert-CHSZJu74.js";import{F as Oe}from"./file-text-_cJWw5Fx.js";import{S as Be}from"./square-pen-wrU9Jooq.js";import{P as Re}from"./phone-CnbjRpiL.js";import{C as Ue}from"./car-DWakAuoX.js";import{s as Ve}from"./subDays-C0x2vdMe.js";import{i as $e}from"./isWithinInterval-BE2QmPlL.js";import{f as H}from"./format-DSNd7y_7.js";import"./chevron-down-n_8xVDCk.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ze=ce("Star",[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]]);function qe({open:s,onOpenChange:x,customerId:h,customerName:u,onComplaintAdded:D}){const{user:c}=de(),{toast:v}=G(),[l,d]=o.useState(""),[C,m]=o.useState(!1),r=async()=>{if(!(!l.trim()||!c)){m(!0);try{await xe(h,{description:l.trim(),createdBy:c.id,createdByName:c.fullName}),v({title:"Complaint added",description:`Complaint recorded for ${u}.`}),d(""),x(!1),D()}catch(p){console.error("Error adding complaint:",p),v({variant:"destructive",title:"Error",description:"Failed to add complaint. Please try again."})}finally{m(!1)}}};return e.jsx(F,{open:s,onOpenChange:x,children:e.jsxs(O,{className:"sm:max-w-md",children:[e.jsx(B,{children:e.jsxs("div",{className:"flex items-center gap-3 mb-1",children:[e.jsx("div",{className:"h-10 w-10 rounded-xl bg-amber-500/20 flex items-center justify-center",children:e.jsx($,{className:"h-5 w-5 text-amber-600"})}),e.jsxs("div",{children:[e.jsx(R,{children:"Add Complaint"}),e.jsxs(U,{children:["Record a complaint for ",u]})]})]})}),e.jsx("div",{className:"space-y-4 py-2",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{htmlFor:"complaint-desc",children:"Complaint Description *"}),e.jsx(_,{id:"complaint-desc",value:l,onChange:p=>d(p.target.value),placeholder:"Describe the complaint or issue...",rows:4,className:"resize-none"})]})}),e.jsxs(V,{children:[e.jsx(b,{variant:"outline",onClick:()=>x(!1),children:"Cancel"}),e.jsx(b,{onClick:r,disabled:!l.trim()||C,className:"bg-amber-600 hover:bg-amber-700 text-white",children:C?e.jsxs(e.Fragment,{children:[e.jsx(me,{className:"h-4 w-4 mr-2 animate-spin"}),"Saving..."]}):"Add Complaint"})]})]})})}function Ke({customer:s,jobs:x,vehicles:h,onEdit:u,onDelete:D,onViewJobs:c,onAddComplaint:v,t:l}){const d=x.filter(r=>r.status==="completed").length,C=d*350,m=x.length>0?x.sort((r,p)=>new Date(p.createdAt).getTime()-new Date(r.createdAt).getTime())[0]:null;return e.jsx(A,{className:"border-0 shadow-sm hover:shadow-md transition-all duration-300 group",children:e.jsxs(M,{className:"p-5",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-gradient-to-br from-primary/20 to-primary/10 flex items-center justify-center",children:e.jsx("span",{className:"text-lg font-semibold text-primary",children:s.name.split(" ").map(r=>r[0]).join("").slice(0,2)})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"font-semibold",children:s.name}),s.complaints&&s.complaints.length>0&&e.jsxs(Q,{variant:"secondary",className:"bg-amber-100 text-amber-700 dark:bg-amber-900/50 dark:text-amber-400",children:[e.jsx(Fe,{className:"h-3 w-3 mr-1"}),s.complaints.length]})]}),x.length>3&&e.jsxs(Q,{variant:"secondary",className:"text-xs mt-1",children:[e.jsx(ze,{className:"h-3 w-3 mr-1"}),l("customers.loyalCustomer")]})]})]}),e.jsxs(De,{children:[e.jsx(Se,{asChild:!0,children:e.jsx(b,{variant:"ghost",size:"icon",className:"h-8 w-8 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(Te,{className:"h-4 w-4"})})}),e.jsxs(Ae,{align:"end",children:[e.jsxs(I,{onClick:c,children:[e.jsx(Oe,{className:"h-4 w-4 mr-2"}),l("customers.viewJobs")]}),e.jsxs(I,{onClick:v,children:[e.jsx($,{className:"h-4 w-4 mr-2"}),l("customers.addComplaint")]}),e.jsxs(I,{onClick:u,children:[e.jsx(Be,{className:"h-4 w-4 mr-2"}),l("common.edit")]}),e.jsx(Me,{}),e.jsxs(I,{className:"text-destructive",onClick:D,children:[e.jsx(je,{className:"h-4 w-4 mr-2"}),l("common.delete")]})]})]})]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(Re,{className:"h-4 w-4"}),e.jsx("span",{children:s.phone})]}),s.email&&e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(ge,{className:"h-4 w-4"}),e.jsx("span",{className:"truncate",children:s.email})]})]}),e.jsx("div",{className:"mt-4 pt-4 border-t",children:e.jsxs("div",{className:"grid grid-cols-3 gap-2 text-center",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-lg font-bold text-primary",children:s.jobCount}),e.jsx("p",{className:"text-xs text-muted-foreground",children:l("customers.totalJobs")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-lg font-bold text-emerald-600",children:d}),e.jsx("p",{className:"text-xs text-muted-foreground",children:l("customers.completed")})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-lg font-bold text-violet-600",children:["€",C]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:l("customers.revenue")})]})]})}),m&&e.jsxs("div",{className:"mt-4 p-3 rounded-lg bg-muted/30",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground mb-1",children:[e.jsx(fe,{className:"h-3 w-3"}),l("customers.lastVisit")]}),e.jsxs("p",{className:"text-sm font-medium truncate",children:[m.problemDescription.slice(0,50),"..."]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:H(new Date(m.createdAt),"dd/MM/yyyy")})]}),h.length>0&&e.jsxs("div",{className:"mt-4 p-3 rounded-lg bg-blue-50/50 dark:bg-blue-950/20 border border-blue-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs font-semibold text-blue-700 dark:text-blue-400 mb-2",children:[e.jsx(Ue,{className:"h-3 w-3"}),l("customers.vehicles")," (",h.length,")"]}),e.jsxs("div",{className:"space-y-1",children:[h.slice(0,3).map(r=>e.jsxs("div",{className:"text-xs text-muted-foreground",children:[r.brand," ",r.model," • ",r.licensePlate]},r.id)),h.length>3&&e.jsxs("p",{className:"text-xs text-muted-foreground italic",children:["+",h.length-3," ",l("customers.more")]})]})]}),s.complaints&&s.complaints.length>0&&e.jsxs("div",{className:"mt-4 p-3 rounded-lg bg-amber-50/50 dark:bg-amber-950/20 border border-amber-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs font-semibold text-amber-700 dark:text-amber-400 mb-2",children:[e.jsx($,{className:"h-3 w-3"}),l("customers.complaints")," (",s.complaints.length,")"]}),e.jsxs("div",{className:"space-y-2",children:[s.complaints.sort((r,p)=>new Date(p.createdAt).getTime()-new Date(r.createdAt).getTime()).slice(0,2).map(r=>e.jsxs("div",{className:"text-xs",children:[e.jsxs("p",{className:"text-foreground leading-relaxed",children:[r.description.slice(0,80),"..."]}),e.jsxs("p",{className:"text-muted-foreground mt-1",children:[H(new Date(r.createdAt),"dd/MM/yyyy")," • ",r.createdByName]})]},r.id)),s.complaints.length>2&&e.jsxs("p",{className:"text-xs text-muted-foreground italic",children:["+",s.complaints.length-2," ",l("customers.more")]})]})]})]})})}function xs(){const{t:s}=he(),x=ue(),{toast:h}=G(),[u,D]=o.useState(""),[c,v]=o.useState("jobs"),[l,d]=o.useState(!1),[C,m]=o.useState(!1),[r,p]=o.useState(!1),[w,L]=o.useState(null),[X,z]=o.useState(0),[j,y]=o.useState({name:"",phone:"",email:"",notes:""}),[g,Y]=o.useState([]),[f,ee]=o.useState([]),[se,te]=o.useState([]),[ae,q]=o.useState(!0);o.useEffect(()=>{(async()=>{q(!0);try{const[a,i,N]=await Promise.all([Ne(),be(),ve()]);Y(a),ee(i),te(N)}catch(a){console.error("Error loading customers data:",a)}finally{q(!1)}})()},[X]);const K=o.useMemo(()=>{let t=f.filter(a=>a.name.toLowerCase().includes(u.toLowerCase())||a.phone.includes(u)||a.email&&a.email.toLowerCase().includes(u.toLowerCase()));return c==="jobs"?t.sort((a,i)=>{const N=g.filter(n=>n.customerPhone===a.phone).length;return g.filter(n=>n.customerPhone===i.phone).length-N}):c==="name"?t.sort((a,i)=>a.name.localeCompare(i.name)):c==="recent"&&t.sort((a,i)=>{const N=g.filter(n=>n.customerPhone===a.phone).sort((n,P)=>new Date(P.createdAt).getTime()-new Date(n.createdAt).getTime())[0],S=g.filter(n=>n.customerPhone===i.phone).sort((n,P)=>new Date(P.createdAt).getTime()-new Date(n.createdAt).getTime())[0];return N?S?new Date(S.createdAt).getTime()-new Date(N.createdAt).getTime():-1:1}),t},[f,u,c,g]),k=o.useMemo(()=>{const t=new Date,a=Ve(t,30),i=f.filter(n=>n.createdAt&&$e(new Date(n.createdAt),{start:a,end:t})),N=f.filter(n=>g.filter(ie=>ie.customerPhone===n.phone).length>3),S=g.filter(n=>n.status==="completed").length*350;return{total:f.length,newThisMonth:i.length,loyal:N.length,totalRevenue:S,avgJobsPerCustomer:f.length>0?Math.round(g.length/f.length*10)/10:0}},[f,g]),re=t=>g.filter(a=>a.customerPhone===t),le=t=>t.vehicleIds&&t.vehicleIds.length>0?se.filter(a=>{var i;return(i=t.vehicleIds)==null?void 0:i.includes(a.id)}):[],ne=()=>{const t={id:Ce(),name:j.name,phone:j.phone,email:j.email||void 0,notes:j.notes||void 0,createdAt:new Date().toISOString()};we(t),d(!1),y({name:"",phone:"",email:"",notes:""}),z(a=>a+1),h({title:"Customer added",description:`${t.name} has been added to the database.`})},oe=()=>{m(!1),L(null),h({title:"Note",description:"Customer records are preserved for job history. Jobs will remain in the system."})};return ae?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("p",{className:"text-muted-foreground",children:s("customers.loading")})}):e.jsxs("div",{className:"space-y-8 pb-8",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:s("customers.title")}),e.jsx("p",{className:"text-muted-foreground",children:s("customers.subtitle")})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(b,{size:"sm",className:"h-9",onClick:()=>d(!0),children:[e.jsx(W,{className:"h-4 w-4 mr-2"}),s("customers.addCustomer")]})})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(A,{className:"border-0 shadow-sm",children:e.jsx(M,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Z,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:k.total}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("customers.totalCustomers")})]})]})})}),e.jsx(A,{className:"border-0 shadow-sm",children:e.jsx(M,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(W,{className:"h-5 w-5 text-emerald-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:k.newThisMonth}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("customers.newThisMonth")})]})]})})}),e.jsx(A,{className:"border-0 shadow-sm",children:e.jsx(M,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ye,{className:"h-5 w-5 text-amber-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:k.loyal}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("customers.loyalCustomers")})]})]})})}),e.jsx(A,{className:"border-0 shadow-sm",children:e.jsx(M,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(pe,{className:"h-5 w-5 text-violet-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:k.avgJobsPerCustomer}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("customers.avgJobsPerCustomer")})]})]})})})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"relative flex-1 max-w-md",children:[e.jsx(Le,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(J,{placeholder:s("customers.searchPlaceholder"),className:"pl-10 h-10 bg-muted/30 border-0",value:u,onChange:t=>D(t.target.value)})]}),e.jsxs(ke,{value:c,onValueChange:v,children:[e.jsxs(Pe,{className:"w-44 h-10 bg-muted/30 border-0",children:[e.jsx(Ee,{className:"h-4 w-4 mr-2 text-muted-foreground"}),e.jsx(Je,{placeholder:s("customers.sortBy")})]}),e.jsxs(Ie,{children:[e.jsx(E,{value:"jobs",children:s("customers.mostJobs")}),e.jsx(E,{value:"name",children:s("customers.nameAZ")}),e.jsx(E,{value:"recent",children:s("customers.mostRecent")})]})]})]}),e.jsxs("div",{className:"grid md:grid-cols-2 lg:grid-cols-3 gap-5",children:[K.map((t,a)=>e.jsx(Ke,{customer:t,jobs:re(t.phone),vehicles:le(t),onEdit:()=>{y({name:t.name,phone:t.phone,email:t.email||"",notes:t.notes||""}),d(!0)},onDelete:()=>{L(t),m(!0)},onAddComplaint:()=>{L(t),p(!0)},onViewJobs:()=>x(`/jobs?customer=${encodeURIComponent(t.phone)}`),t:s},`${t.id}-${a}`)),K.length===0&&e.jsxs("div",{className:"col-span-full text-center py-12",children:[e.jsx(Z,{className:"h-12 w-12 text-muted-foreground/30 mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:s("customers.noCustomersFound")})]})]}),e.jsx(F,{open:l,onOpenChange:d,children:e.jsxs(O,{className:"sm:max-w-md",children:[e.jsxs(B,{children:[e.jsx(R,{children:s("customers.addCustomer")}),e.jsx(U,{children:s("customers.addCustomerDialog")})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{children:s("customers.fullName")}),e.jsx(J,{value:j.name,onChange:t=>y(a=>({...a,name:t.target.value})),placeholder:s("customers.enterName")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{children:s("customers.phoneNumber")}),e.jsx(J,{value:j.phone,onChange:t=>y(a=>({...a,phone:t.target.value})),placeholder:s("customers.phonePlaceholder")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{children:s("customers.emailOptional")}),e.jsx(J,{type:"email",value:j.email,onChange:t=>y(a=>({...a,email:t.target.value})),placeholder:s("customers.emailPlaceholder")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{children:s("customers.notesOptional")}),e.jsx(_,{value:j.notes,onChange:t=>y(a=>({...a,notes:t.target.value})),placeholder:s("customers.notesPlaceholder"),rows:3})]})]}),e.jsxs(V,{children:[e.jsx(b,{variant:"outline",onClick:()=>d(!1),children:s("common.cancel")}),e.jsx(b,{onClick:ne,disabled:!j.name||!j.phone,children:s("customers.addCustomer")})]})]})}),e.jsx(F,{open:C,onOpenChange:m,children:e.jsxs(O,{className:"sm:max-w-md",children:[e.jsxs(B,{children:[e.jsx(R,{children:s("customers.deleteTitle")}),e.jsx(U,{children:s("customers.deleteConfirm").replace("{name}",(w==null?void 0:w.name)||"")})]}),e.jsxs(V,{children:[e.jsx(b,{variant:"outline",onClick:()=>m(!1),children:s("common.cancel")}),e.jsx(b,{variant:"destructive",onClick:oe,children:s("common.delete")})]})]})}),w&&e.jsx(qe,{open:r,onOpenChange:p,customerId:w.id,customerName:w.name,onComplaintAdded:()=>{z(t=>t+1)}})]})}export{xs as default};
