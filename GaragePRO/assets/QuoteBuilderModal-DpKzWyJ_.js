import{c as _,o as he,u as pe,r as d,s as f,j as e,C as fe,B as k,N as v,ao as ge,ar as D,K as R,P as je,M as ve,_ as N,aq as ye}from"./index-CNxWMcuV.js";import{g as Ne,a as be}from"./partsService-DfpAxGHT.js";import{g as qe,a as we}from"./servicesService-CCLYMeGf.js";import{g as Ie}from"./companySettingsService-BheHf_-3.js";import{e as g,f as Ce,h as Pe}from"./quoteService-j1Naoogm.js";import{R as ke,e as Te}from"./invoiceService-B8qPXtsv.js";import{D as L,b as F,d as M,c as W,e as Se}from"./dialog-CIS6byhQ.js";import{T as De}from"./textarea-D6buyuls.js";import{T as Re,a as Le,b as G,c as K}from"./tabs-gg0ONG9Z.js";import{S as Fe,a as Me,b as Ae,c as $e,d as Y}from"./select-CbHlLrev.js";import{F as Qe}from"./file-text-_cJWw5Fx.js";import{S as Ue}from"./search-vDLcJ1l5.js";import{P as He}from"./package-8-BxBKwT.js";import{E as Ee}from"./euro-JmB74vkB.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oe=_("Calculator",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["line",{x1:"8",x2:"16",y1:"6",y2:"6",key:"x4nwl0"}],["line",{x1:"16",x2:"16",y1:"14",y2:"18",key:"wjye3r"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M8 18h.01",key:"lrp35t"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const at=_("Hash",[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]]);function rt({job:x,isOpen:b,onClose:q,onQuoteCreated:A,mode:w="quote",existingLineItems:S,existingNotes:X,existingCustomerNotes:Z}){const{user:I}=he(),{t:s}=pe(),[ee,$]=d.useState(!0),[Q,U]=d.useState(!1),[H,te]=d.useState([]),[E,se]=d.useState([]),[n,ae]=d.useState(null),[i,m]=d.useState([]),[O,re]=d.useState(""),[B,J]=d.useState(""),[h,oe]=d.useState("");d.useEffect(()=>{b&&ie()},[b]);const ie=async()=>{try{$(!0);const[t,a,r]=await Promise.all([Ne(),qe(),Ie()]);if(te(t),se(a),ae(r),!r){f.error(s("quote.configureSettings"));return}if(S&&S.length>0){m(S),re(X||""),J(Z||"");return}const u=r.defaultTaxRate||20,c=[];if(x.workOrderData){const y=x.workOrderData,xe=new Map(a.map(o=>[o.id,o])),me=new Map(t.map(o=>[o.id,o]));for(const o of y.workItems){let l=o.fixedPrice!=null?o.fixedPrice:o.pricePerHour||0,j=1;if(!l&&o.serviceId){const P=xe.get(o.serviceId);P&&(P.pricingType==="hourly"?(l=P.hourlyRate||0,j=o.durationHours>0?o.durationHours:P.estimatedDuration||1):(l=P.fixedPrice||0,j=1))}else o.pricePerHour&&o.durationHours>0&&(j=o.durationHours);c.push(g({id:crypto.randomUUID(),type:o.isCustom?"custom":"service",referenceId:o.serviceId,code:o.serviceCode||void 0,description:o.serviceName+(o.serviceCode?` (${o.serviceCode})`:""),quantity:j,unitPrice:l,taxRate:u,discount:0}))}for(const o of y.parts){let l=o.unitPrice||0;if(!l&&o.partId){const j=me.get(o.partId);j&&(l=j.sellingPrice||0)}c.push(g({id:crypto.randomUUID(),type:o.isCustom?"custom":"part",referenceId:o.partId,code:o.partNumber||void 0,description:o.partName+(o.partNumber?` (${o.partNumber})`:""),quantity:o.quantity,unitPrice:l,taxRate:u,discount:0}))}y.discountPercent>0&&c.forEach(o=>{const l=g({...o,discount:y.discountPercent});Object.assign(o,l)})}m(c)}catch(t){console.error("Error loading data:",t),f.error(s("quote.failedToLoad"))}finally{$(!1)}},ne=t=>{const a=i.findIndex(r=>r.type==="part"&&r.referenceId===t.id);if(a>=0){const r=[...i];r[a]=g({...r[a],quantity:r[a].quantity+1}),m(r)}else{const r=g({id:crypto.randomUUID(),type:"part",referenceId:t.id,code:t.partNumber||void 0,description:t.name,quantity:1,unitPrice:t.sellingPrice,taxRate:t.taxRate||(n==null?void 0:n.defaultTaxRate)||20,discount:0});m([r,...i])}},ce=t=>{if(i.findIndex(c=>c.type==="service"&&c.referenceId===t.id)>=0){f.info(s("quote.serviceAlreadyAdded"));return}const r=t.pricingType==="hourly"?(t.hourlyRate||0)*(t.estimatedDuration||1):t.fixedPrice||0,u=g({id:crypto.randomUUID(),type:"service",referenceId:t.id,code:t.serviceCode||void 0,description:t.name,quantity:t.pricingType==="hourly"&&t.estimatedDuration||1,unitPrice:t.pricingType==="hourly"?t.hourlyRate||0:r,taxRate:t.taxRate||(n==null?void 0:n.defaultTaxRate)||20,discount:0});m([u,...i])},le=()=>{const t=g({id:crypto.randomUUID(),type:"custom",description:"",quantity:1,unitPrice:0,taxRate:(n==null?void 0:n.defaultTaxRate)||20,discount:0});m([t,...i])},p=(t,a,r)=>{const u=i.map(c=>{if(c.id===t){const y={...c,[a]:r};return g(y)}return c});m(u)},de=t=>{m(i.filter(a=>a.id!==t))},C=Ce(i),V=h?H.filter(t=>{var a;return t.name.toLowerCase().includes(h.toLowerCase())||((a=t.partNumber)==null?void 0:a.toLowerCase().includes(h.toLowerCase()))}):H,z=h?E.filter(t=>t.name.toLowerCase().includes(h.toLowerCase())):E,ue=async()=>{if(!I)return;if(i.length===0){f.error(`${s("quote.addAtLeastOne")} ${w==="invoice"?s("quote.createInvoice").toLowerCase():s("quote.createQuote").toLowerCase()}`);return}if(i.filter(a=>!a.description.trim()).length>0){f.error(s("quote.allItemsNeedDescription"));return}try{U(!0);const a=i.filter(r=>!r.referenceId&&r.description.trim());if(await Promise.all(a.map(r=>{const u=(n==null?void 0:n.defaultTaxRate)||20;return r.type==="part"?be({partNumber:r.code||"",name:r.description.trim(),description:"",category:"custom",stockQuantity:0,minStockLevel:1,maxStockLevel:10,unit:"piece",costPrice:0,sellingPrice:r.unitPrice||0,markup:0,taxRate:r.taxRate||u,isActive:!0},I.id).catch(()=>{}):we({serviceCode:r.code||"",name:r.description.trim(),description:"",category:"custom",pricingType:"fixed",fixedPrice:r.unitPrice||0,estimatedDuration:r.quantity||1,taxRate:r.taxRate||u,skillLevel:"junior",includesParts:!1,isActive:!0},I.id).catch(()=>{})})),w==="invoice"){const r=await Te(x.id,i,I.id,{notes:O||void 0});f.success(`${s("quote.createInvoice")} ${s("quote.created")}`),A(r)}else{const r=await Pe(x.id,i,I.id,{notes:O,customerNotes:B});f.success(`${s("quote.createQuote")} ${s("quote.created")}`),A(r)}q()}catch(a){console.error(`Error creating ${w}:`,a),f.error(a.message||`${s("quote.failedToCreate")} ${w==="invoice"?s("quote.createInvoice").toLowerCase():s("quote.createQuote").toLowerCase()}`)}finally{U(!1)}},T=w==="invoice";return ee?e.jsx(L,{open:b,onOpenChange:q,children:e.jsxs(F,{className:"max-w-5xl","aria-describedby":void 0,children:[e.jsx(M,{className:"sr-only",children:s("quote.loading")}),e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})})]})}):n?e.jsx(L,{open:b,onOpenChange:q,children:e.jsxs(F,{className:"max-w-5xl max-h-[95vh] overflow-hidden flex flex-col",children:[e.jsxs(W,{children:[e.jsxs(M,{className:"flex items-center gap-2",children:[T?e.jsx(ke,{className:"h-5 w-5"}):e.jsx(Qe,{className:"h-5 w-5"}),s(T?"quote.createInvoice":"quote.createQuote")," ",s("quote.forJob")," #",x.jobNumber]}),e.jsxs(Se,{children:[x.customerName," • ",x.problemDescription.substring(0,50),"...",x.workOrderData&&e.jsxs("span",{className:"ml-2 text-primary font-medium",children:["(",s("quote.preFilledFromWorkOrder"),")"]})]})]}),e.jsxs("div",{className:"flex-1 overflow-hidden flex gap-4",children:[e.jsxs("div",{className:"w-1/3 border-r pr-4 flex flex-col",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:s("quote.addMoreItems")}),e.jsxs("div",{className:"relative mb-2",children:[e.jsx(Ue,{className:"absolute left-2 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground"}),e.jsx(v,{placeholder:s("quote.searchCatalog"),value:h,onChange:t=>oe(t.target.value),className:"pl-8 h-8 text-sm"})]}),e.jsxs(Re,{defaultValue:"parts",className:"flex-1 flex flex-col overflow-hidden",children:[e.jsxs(Le,{className:"grid grid-cols-2 mb-2",children:[e.jsxs(G,{value:"parts",className:"text-xs",children:[e.jsx(He,{className:"h-3 w-3 mr-1"}),s("quote.parts")]}),e.jsxs(G,{value:"services",className:"text-xs",children:[e.jsx(ge,{className:"h-3 w-3 mr-1"}),s("quote.services")]})]}),e.jsx(K,{value:"parts",className:"flex-1 overflow-hidden",children:e.jsx(D,{className:"h-[450px]",children:e.jsxs("div",{className:"space-y-1 pr-2",children:[V.map(t=>e.jsx("button",{onClick:()=>ne(t),className:"w-full text-left p-2 rounded hover:bg-muted transition-colors border border-transparent hover:border-primary/20",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:t.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t.partNumber})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"font-semibold text-sm",children:["€",t.sellingPrice.toFixed(2)]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s("quote.stock")," ",t.stockQuantity]})]})]})},t.id)),V.length===0&&e.jsx("p",{className:"text-center text-muted-foreground py-4 text-sm",children:s(h?"quote.noPartsMatch":"quote.noPartsAvailable")})]})})}),e.jsx(K,{value:"services",className:"flex-1 overflow-hidden",children:e.jsx(D,{className:"h-[450px]",children:e.jsxs("div",{className:"space-y-1 pr-2",children:[z.map(t=>{var a,r;return e.jsx("button",{onClick:()=>ce(t),className:"w-full text-left p-2 rounded hover:bg-muted transition-colors border border-transparent hover:border-primary/20",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:t.name}),e.jsxs("div",{className:"flex items-center gap-1 mt-0.5",children:[e.jsx(R,{variant:"outline",className:"text-xs",children:t.pricingType==="hourly"?s("quote.hourly"):s("quote.fixed")}),t.estimatedDuration&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["~",t.estimatedDuration,"h"]})]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("p",{className:"font-semibold text-sm",children:["€",t.pricingType==="hourly"?`${(a=t.hourlyRate)==null?void 0:a.toFixed(2)}/h`:(r=t.fixedPrice)==null?void 0:r.toFixed(2)]})})]})},t.id)}),z.length===0&&e.jsx("p",{className:"text-center text-muted-foreground py-4 text-sm",children:s(h?"quote.noServicesMatch":"quote.noServicesAvailable")})]})})})]}),e.jsxs(k,{variant:"outline",className:"w-full mt-2",onClick:le,children:[e.jsx(je,{className:"h-4 w-4 mr-2"}),s("quote.addCustomItem")]})]}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-semibold",children:s("quote.quoteItems")}),e.jsxs(R,{variant:"secondary",children:[i.length," ",i.length!==1?s("quote.items"):s("quote.item")]})]}),e.jsx(D,{className:"flex-1",children:e.jsxs("div",{className:"space-y-2 pr-2",children:[i.map(t=>e.jsxs("div",{className:"p-3 border rounded-lg bg-card space-y-2",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:"w-28 shrink-0",children:e.jsx(v,{value:t.code||"",onChange:a=>p(t.id,"code",a.target.value),placeholder:s("wo.referenceOptional"),className:"font-medium"})}),e.jsx("div",{className:"flex-1",children:e.jsx(v,{value:t.description,onChange:a=>p(t.id,"description",a.target.value),placeholder:s("quote.itemDescription"),className:"font-medium"})}),t.type==="custom"||t.type==="part"||t.type==="service"?t.referenceId?e.jsx(R,{variant:"outline",className:"text-xs flex-shrink-0 mt-2",children:t.type==="part"?s("quote.part"):s("quote.service")}):e.jsxs(Fe,{value:t.type,onValueChange:a=>p(t.id,"type",a),children:[e.jsx(Me,{className:"w-24 h-8 text-xs flex-shrink-0 mt-1",children:e.jsx(Ae,{})}),e.jsxs($e,{children:[e.jsx(Y,{value:"service",children:s("quote.service")}),e.jsx(Y,{value:"part",children:s("quote.part")})]})]}):null,e.jsx(k,{variant:"ghost",size:"icon",onClick:()=>de(t.id),children:e.jsx(ve,{className:"h-4 w-4 text-destructive"})})]}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsxs("div",{className:"grid grid-cols-5 gap-2 flex-1",children:[e.jsxs("div",{children:[e.jsx(N,{className:"text-xs",children:s("quote.qty")}),e.jsx(v,{type:"number",min:"0.1",step:"0.1",value:t.quantity||"",onChange:a=>p(t.id,"quantity",Number(a.target.value)),onFocus:a=>a.target.select(),className:"h-8"})]}),e.jsxs("div",{children:[e.jsx(N,{className:"text-xs",children:s("quote.unitPrice")}),e.jsx(v,{type:"number",min:"0",step:"0.01",value:t.unitPrice||"",onChange:a=>p(t.id,"unitPrice",Number(a.target.value)),onFocus:a=>a.target.select(),className:"h-8"})]}),e.jsxs("div",{children:[e.jsx(N,{className:"text-xs",children:s("quote.discount")}),e.jsx(v,{type:"number",min:"0",max:"100",value:t.discount||"",onChange:a=>p(t.id,"discount",Number(a.target.value)),onFocus:a=>a.target.select(),className:"h-8"})]}),e.jsxs("div",{children:[e.jsx(N,{className:"text-xs",children:s("quote.tax")}),e.jsx(v,{type:"number",min:"0",max:"100",value:t.taxRate||"",onChange:a=>p(t.id,"taxRate",Number(a.target.value)),onFocus:a=>a.target.select(),className:"h-8"})]}),e.jsxs("div",{children:[e.jsx(N,{className:"text-xs",children:s("quote.total")}),e.jsxs("div",{className:"h-8 flex items-center font-semibold",children:["€",t.total.toFixed(2)]})]})]}),e.jsx("button",{type:"button",onClick:()=>p(t.id,"discount",t.discount===100?0:100),className:`h-9 px-4 rounded-lg text-xs font-bold transition-all flex-shrink-0 ${t.discount===100?"bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-md hover:shadow-lg hover:from-green-600 hover:to-emerald-600":"bg-gradient-to-r from-green-50 to-emerald-50 text-green-700 border border-green-200 hover:border-green-300 hover:shadow-sm"}`,children:"GRATUIT"})]})]},t.id)),i.length===0&&e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(Oe,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:s("quote.noItemsYet")}),e.jsx("p",{className:"text-sm",children:s("quote.selectFromPanel")})]})]})}),i.length>0&&e.jsxs("div",{className:"mt-4 pt-4 border-t space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:s("quote.subtotal")}),e.jsxs("span",{children:["€",C.subtotal.toFixed(2)]})]}),C.discountTotal>0&&e.jsxs("div",{className:"flex justify-between text-sm text-green-600",children:[e.jsx("span",{children:s("quote.discountTotal")}),e.jsxs("span",{children:["-€",C.discountTotal.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:s("quote.taxTotal")}),e.jsxs("span",{children:["€",C.taxTotal.toFixed(2)]})]}),e.jsx(ye,{className:"my-2"}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:s("quote.grandTotal")}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Ee,{className:"h-4 w-4"}),C.grandTotal.toFixed(2)]})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx(N,{htmlFor:"customerNotes",className:"text-xs",children:s("quote.customerNotes")}),e.jsx(De,{id:"customerNotes",value:B,onChange:t=>J(t.target.value),placeholder:s("quote.customerNotesPlaceholder"),className:"h-16 text-sm"})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx(k,{variant:"outline",onClick:q,children:s("quote.cancel")}),e.jsx(k,{onClick:ue,disabled:Q||i.length===0,className:T?"bg-green-600 hover:bg-green-700":void 0,children:s(Q?"quote.creating":T?"quote.createInvoice":"quote.createQuote")})]})]})}):e.jsx(L,{open:b,onOpenChange:q,children:e.jsxs(F,{children:[e.jsx(W,{children:e.jsx(M,{children:s("quote.settingsRequired")})}),e.jsxs("div",{className:"flex flex-col items-center justify-center py-8 text-center",children:[e.jsx(fe,{className:"h-12 w-12 text-amber-500 mb-4"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:s("quote.configureSettings")}),e.jsx(k,{onClick:()=>window.location.href="/company-settings",children:s("quote.goToSettings")})]})]})})}export{at as H,rt as Q};
