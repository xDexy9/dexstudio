import{aD as ne,bO as re,d as oe,o as ie,u as ce,r as x,j as e,B as h,e as $,i as E,Z as L,aq as y,$ as le,K as C,aQ as de}from"./index-CNxWMcuV.js";import{R as me,b as xe,d as ue}from"./invoiceService-B8qPXtsv.js";import{b as pe,c as he}from"./quoteService-j1Naoogm.js";import{g as fe}from"./companySettingsService-BheHf_-3.js";import{a as Q,p as V}from"./pdfGenerator-DtjVo1jc.js";import{H as je,Q as ge}from"./QuoteBuilderModal-DpKzWyJ_.js";import{S as Ne}from"./SendQuoteModal-DK7bLIAq.js";import{A as q}from"./arrow-left-5j_RihUX.js";import{T as be}from"./triangle-alert-CHSZJu74.js";import{F as ve}from"./file-text-_cJWw5Fx.js";import{C as we}from"./chevron-down-n_8xVDCk.js";import{P as ye}from"./pencil-BmBYV1qM.js";import{D as Ce}from"./download-CwOjd3gN.js";import{P as De}from"./printer-BEYF_3-0.js";import{P as z}from"./phone-CnbjRpiL.js";import{M as Se}from"./map-pin-CEelsx8N.js";import{C as Ie}from"./car-DWakAuoX.js";import{C as Pe}from"./circle-check-big-a_8kXWWc.js";import"./format-DSNd7y_7.js";import"./partsService-DfpAxGHT.js";import"./servicesService-CCLYMeGf.js";import"./dialog-CIS6byhQ.js";import"./textarea-D6buyuls.js";import"./tabs-gg0ONG9Z.js";import"./select-CbHlLrev.js";import"./search-vDLcJ1l5.js";import"./package-8-BxBKwT.js";import"./euro-JmB74vkB.js";import"./send-DWCkg-NG.js";import"./external-link-ChWnHVz5.js";function rt(){var M;const{quoteId:U,invoiceId:J}=ne(),H=re(),f=oe(),{user:D}=ie(),{t:n}=ce(),r=H.pathname.startsWith("/invoices")?"invoice":"quote",S=r==="invoice"?J:U,[s,O]=x.useState(null),[c,R]=x.useState(null),[a,G]=x.useState(null),[u,I]=x.useState([]),[K,g]=x.useState(!0),[P,N]=x.useState(null),[W,v]=x.useState(!1),[Z,T]=x.useState(!1),[A,k]=x.useState(!1),b=async t=>{const o=t||S;if(!o){N("No document ID provided"),g(!1);return}g(!0),N(null);try{const l=r==="invoice"?await xe(o):await pe(o);if(!l){N("Document not found"),g(!1);return}O(l);const[p,te]=await Promise.all([de(l.jobId),fe()]);R(p),G(te);try{const w=r==="invoice"?await ue(l.jobId):await he(l.jobId);I(w.sort((se,ae)=>new Date(ae.createdAt).getTime()-new Date(se.createdAt).getTime()))}catch(w){console.warn("Could not fetch versions (index may be needed):",w),I([l])}}catch(l){console.error("Error loading document:",l),N("Failed to load document")}finally{g(!1)}};x.useEffect(()=>{b()},[S,r]);const X=async()=>{if(!(!s||!a))try{r==="invoice"?await Q(s,a,c||void 0):await V(s,a,c||void 0)}catch(t){console.error("PDF download error:",t)}},Y=async()=>{if(!(!s||!a))try{r==="invoice"?await Q(s,a,c||void 0):await V(s,a,c||void 0)}catch(t){console.error("PDF print error:",t)}},F=t=>{if(k(!1),t!==(s==null?void 0:s.id)){b(t);const o=r==="invoice"?`/invoices/${t}`:`/quotes/${t}`;f(o,{replace:!0})}},B=()=>s?r==="invoice"?s.invoiceNumber:s.quoteNumber:"",_=()=>{if(!s)return null;if(r==="invoice"){const t=s,o={unpaid:"bg-red-100 text-red-700",partial:"bg-amber-100 text-amber-700",paid:"bg-green-100 text-green-700",overdue:"bg-red-200 text-red-800",cancelled:"bg-gray-100 text-gray-600"};return e.jsx(C,{className:o[t.paymentStatus]||"bg-gray-100",children:t.paymentStatus.toUpperCase()})}else{const t=s,o={draft:"bg-gray-100 text-gray-700",sent:"bg-blue-100 text-blue-700",viewed:"bg-cyan-100 text-cyan-700",approved:"bg-green-100 text-green-700",rejected:"bg-red-100 text-red-700",expired:"bg-amber-100 text-amber-700",converted:"bg-purple-100 text-purple-700"};return e.jsx(C,{className:o[t.status]||"bg-gray-100",children:t.status.toUpperCase()})}},j=t=>{try{return new Date(t).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}catch{return t}},d=t=>`â‚¬${t.toFixed(2)}`;if(K)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})});if(P||!s)return e.jsxs("div",{className:"safe-top pb-8 px-4 pt-4",children:[e.jsx(h,{variant:"ghost",size:"icon",onClick:()=>f(-1),children:e.jsx(q,{className:"h-5 w-5"})}),e.jsxs("div",{className:"text-center mt-12",children:[e.jsx(be,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:P||"Document not found"})]})]});const m=r==="invoice"?s:null,i=r==="quote"?s:null,ee=u.findIndex(t=>t.id===s.id);return e.jsxs("div",{className:"safe-top pb-8",children:[e.jsxs("div",{className:"px-4 pt-4 pb-3",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx(h,{variant:"ghost",size:"icon",onClick:()=>{f(c?`/jobs/${c.id}`:-1)},children:e.jsx(q,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[r==="invoice"?e.jsx(me,{className:"h-5 w-5 text-green-600"}):e.jsx(ve,{className:"h-5 w-5 text-blue-600"}),e.jsx("h1",{className:"text-lg font-bold font-mono",children:B()}),_()]}),c&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[n("document.backToJob"),": ",c.customerName," - ",(M=c.problemDescription)==null?void 0:M.substring(0,40),"..."]})]})]}),u.length>1&&e.jsxs("div",{className:"relative mb-3",children:[e.jsxs(h,{variant:"outline",size:"sm",className:"w-full justify-between",onClick:()=>k(!A),children:[e.jsxs("span",{children:[n("document.version")," ",u.length-ee," / ",u.length]}),e.jsx(we,{className:"h-4 w-4 ml-2"})]}),A&&e.jsx("div",{className:"absolute top-full left-0 right-0 z-50 mt-1 bg-background border rounded-lg shadow-lg max-h-48 overflow-y-auto",children:u.map((t,o)=>{const l=r==="invoice"?t.invoiceNumber:t.quoteNumber,p=t.id===s.id;return e.jsxs("button",{className:`w-full text-left px-3 py-2 text-sm hover:bg-accent flex items-center justify-between ${p?"bg-accent font-medium":""}`,onClick:()=>F(t.id),children:[e.jsxs("span",{children:["v",u.length-o," - ",l]}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[j(t.createdAt)," - ",d(t.grandTotal)]})]},t.id)})})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[c&&e.jsxs(h,{size:"sm",variant:"outline",onClick:()=>v(!0),children:[e.jsx(ye,{className:"h-4 w-4 mr-1"}),n("document.editDocument")]}),e.jsxs(h,{size:"sm",variant:"outline",onClick:X,disabled:!a,children:[e.jsx(Ce,{className:"h-4 w-4 mr-1"}),n("document.downloadPDF")]}),e.jsxs(h,{size:"sm",variant:"outline",onClick:Y,disabled:!a,children:[e.jsx(De,{className:"h-4 w-4 mr-1"}),n("document.print")]})]})]}),e.jsxs("div",{className:"px-4 space-y-4",children:[e.jsx($,{className:"shadow-lg border-0 bg-white document-preview",children:e.jsxs(E,{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[(a==null?void 0:a.companyName)&&e.jsx("h2",{className:"text-xl font-bold",children:a.companyName}),(a==null?void 0:a.address)&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1 whitespace-pre-line",children:[a.address.street,`
`,a.address.city,", ",a.address.postalCode,`
`,a.address.country]}),(a==null?void 0:a.phone)&&e.jsxs("p",{className:"text-xs text-muted-foreground flex items-center gap-1 mt-1",children:[e.jsx(z,{className:"h-3 w-3"}),a.phone]}),(a==null?void 0:a.email)&&e.jsxs("p",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[e.jsx(L,{className:"h-3 w-3"}),a.email]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("h3",{className:"text-lg font-bold text-primary uppercase",children:r==="invoice"?"INVOICE":"QUOTE"}),e.jsx("p",{className:"font-mono font-bold text-sm",children:B()}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-2 space-y-0.5",children:[e.jsxs("p",{children:[n("document.issueDate"),": ",j(s.issueDate||s.createdAt)]}),(m==null?void 0:m.dueDate)&&e.jsxs("p",{children:[n("document.dueDate"),": ",j(m.dueDate)]}),(i==null?void 0:i.validUntil)&&e.jsxs("p",{children:[n("document.validUntil"),": ",j(i.validUntil)]})]})]})]}),e.jsx(y,{}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-muted/50 rounded-lg p-3",children:[e.jsxs("p",{className:"text-xs font-semibold text-muted-foreground uppercase mb-2 flex items-center gap-1",children:[e.jsx(le,{className:"h-3 w-3"})," ",n("document.customer")]}),e.jsx("p",{className:"font-medium text-sm",children:s.customer.name}),s.customer.phone&&e.jsxs("p",{className:"text-xs text-muted-foreground flex items-center gap-1 mt-1",children:[e.jsx(z,{className:"h-3 w-3"}),s.customer.phone]}),s.customer.email&&e.jsxs("p",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[e.jsx(L,{className:"h-3 w-3"}),s.customer.email]}),(s.customer.postCode||s.customer.region)&&e.jsxs("p",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[e.jsx(Se,{className:"h-3 w-3"}),[s.customer.postCode,s.customer.region].filter(Boolean).join(" ")]})]}),e.jsxs("div",{className:"bg-muted/50 rounded-lg p-3",children:[e.jsxs("p",{className:"text-xs font-semibold text-muted-foreground uppercase mb-2 flex items-center gap-1",children:[e.jsx(Ie,{className:"h-3 w-3"})," ",n("document.vehicle")]}),e.jsxs("p",{className:"font-medium text-sm",children:[s.vehicle.brand," ",s.vehicle.model]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.vehicle.year}),e.jsx("p",{className:"text-xs font-mono font-bold mt-1",children:s.vehicle.licensePlate}),s.vehicle.vin&&e.jsxs("p",{className:"text-xs text-muted-foreground flex items-center gap-1 mt-1",children:[e.jsx(je,{className:"h-3 w-3"}),"VIN: ",s.vehicle.vin]})]})]}),(i==null?void 0:i.customerNotes)&&e.jsx(e.Fragment,{children:e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground uppercase mb-1",children:n("document.customerNotes")}),e.jsx("p",{className:"text-sm bg-blue-50 p-3 rounded-lg italic",children:i.customerNotes})]})}),e.jsx(y,{}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground uppercase mb-3 flex items-center gap-1",children:n("document.partsServices")}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b bg-muted/30",children:[e.jsx("th",{className:"text-left py-2 px-2 font-medium text-xs",children:n("document.description")}),e.jsx("th",{className:"text-center py-2 px-1 font-medium text-xs w-12",children:n("document.qty")}),e.jsx("th",{className:"text-right py-2 px-1 font-medium text-xs w-20",children:n("document.price")}),e.jsx("th",{className:"text-right py-2 px-1 font-medium text-xs w-14",children:n("document.disc")}),e.jsx("th",{className:"text-right py-2 px-1 font-medium text-xs w-14",children:n("document.tax")}),e.jsx("th",{className:"text-right py-2 px-2 font-medium text-xs w-20",children:n("document.total")})]})}),e.jsx("tbody",{children:s.lineItems.map((t,o)=>e.jsxs("tr",{className:"border-b border-muted/50",children:[e.jsx("td",{className:"py-2 px-2",children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(C,{variant:"outline",className:"text-[9px] px-1 py-0 shrink-0",children:t.type==="part"?"P":t.type==="service"?"S":"C"}),e.jsx("span",{className:"text-sm",children:t.description})]})}),e.jsx("td",{className:"text-center py-2 px-1 text-xs",children:t.quantity}),e.jsx("td",{className:"text-right py-2 px-1 text-xs",children:d(t.unitPrice)}),e.jsx("td",{className:"text-right py-2 px-1 text-xs",children:t.discount>0?`${t.discount}%`:"-"}),e.jsx("td",{className:"text-right py-2 px-1 text-xs",children:t.taxRate>0?`${t.taxRate.toFixed(0)}%`:"-"}),e.jsx("td",{className:"text-right py-2 px-2 text-xs font-medium",children:d(t.total)})]},t.id||o))})]})})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs("div",{className:"w-64 space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:n("document.subtotal")}),e.jsx("span",{children:d(s.subtotal)})]}),s.discountTotal>0&&e.jsxs("div",{className:"flex justify-between text-sm text-green-600",children:[e.jsx("span",{children:n("document.discount")}),e.jsxs("span",{children:["-",d(s.discountTotal)]})]}),s.taxTotal>0&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:n("document.tax")}),e.jsx("span",{children:d(s.taxTotal)})]}),e.jsx(y,{}),e.jsxs("div",{className:"flex justify-between font-bold text-base",children:[e.jsx("span",{children:n("document.total")}),e.jsx("span",{children:d(s.grandTotal)})]})]})}),m&&e.jsxs("div",{className:"flex items-center justify-between bg-muted/50 rounded-lg p-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:n("document.paymentStatus")}),e.jsx("div",{className:"flex items-center gap-2 mt-1",children:m.paidAmount>0&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:[d(m.paidAmount)," / ",d(m.grandTotal)]})})]}),m.remainingAmount>0&&e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:n("document.remaining")}),e.jsx("p",{className:"font-bold text-red-600",children:d(m.remainingAmount)})]})]}),s.notes&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground uppercase mb-1",children:n("document.notes")}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.notes})]})]})}),u.length>1&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold mb-2",children:n("document.versionHistory")}),e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2",children:u.map((t,o)=>{const l=r==="invoice"?t.invoiceNumber:t.quoteNumber,p=t.id===s.id;return e.jsx($,{className:`shrink-0 cursor-pointer transition-all ${p?"ring-2 ring-primary":"hover:bg-accent"}`,onClick:()=>F(t.id),children:e.jsxs(E,{className:"p-3 min-w-[140px]",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("span",{className:"text-xs font-bold",children:["v",u.length-o]}),p&&e.jsx(Pe,{className:"h-3.5 w-3.5 text-primary"})]}),e.jsx("p",{className:"text-xs font-mono",children:l}),e.jsx("p",{className:"text-[10px] text-muted-foreground mt-1",children:j(t.createdAt)}),e.jsx("p",{className:"text-sm font-bold mt-1",children:d(t.grandTotal)})]})},t.id)})})]})]}),c&&s&&e.jsx(ge,{job:c,isOpen:W,onClose:()=>v(!1),mode:r,existingLineItems:s.lineItems,existingNotes:s.notes||"",existingCustomerNotes:(i==null?void 0:i.customerNotes)||"",onQuoteCreated:t=>{v(!1),b(t);const o=r==="invoice"?`/invoices/${t}`:`/quotes/${t}`;f(o,{replace:!0})}}),i&&D&&e.jsx(Ne,{quote:i,open:Z,onOpenChange:T,onSent:()=>{T(!1),b()},userId:D.id})]})}export{rt as default};
